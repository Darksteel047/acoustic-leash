<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Acoustic Leash - Real World Guidance</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #050505;
            color: #f4f4f5;
            user-select: none;
            touch-action: none;
            overflow: hidden;
            font-family: 'Inter', system-ui, sans-serif;
        }
        .status-pill {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        #gps-status.error { color: #f87171; }
        #gps-status.success { color: #34d399; }
        
        /* Visual heartbeat for audio state */
        .audio-pulse {
            position: absolute;
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-radius: 50%;
            animation: sonar 4s linear infinite;
        }
        @keyframes sonar {
            0% { width: 0; height: 0; opacity: 1; }
            100% { width: 600px; height: 600px; opacity: 0; }
        }
    </style>
</head>
<body class="flex flex-col items-center justify-between h-screen p-6 py-12">

    <!-- Header Section -->
    <div class="w-full space-y-4 text-center z-20">
        <h1 class="text-xl font-light tracking-[0.4em] uppercase opacity-40">Acoustic Leash</h1>
        <div class="status-pill rounded-full py-2 px-6 inline-block">
            <span class="text-blue-400 text-[10px] font-bold tracking-widest uppercase">Hostel 15 ‚Üí IDC School of Design</span>
        </div>
        <div id="gps-status" class="text-[10px] font-mono mt-2 uppercase tracking-widest opacity-80">Device Sensors Inactive</div>
    </div>

    <!-- Spatial Visualization (Compass) -->
    <div class="relative w-72 h-72 flex items-center justify-center">
        <div id="pulse-container" class="absolute inset-0 flex items-center justify-center pointer-events-none"></div>
        <div class="absolute inset-0 border border-zinc-800 rounded-full opacity-10"></div>
        
        <!-- User Placeholder (Center) -->
        <div class="z-20 w-4 h-4 bg-white rounded-full shadow-[0_0_20px_rgba(255,255,255,0.6)]"></div>
        
        <!-- Virtual Dog Representation -->
        <div id="dog-avatar" class="absolute w-10 h-10 flex items-center justify-center transition-all duration-500 opacity-0">
            <span class="text-2xl filter drop-shadow(0 0 5px rgba(255,255,255,0.5))">üêï</span>
        </div>
        
        <!-- Auditory Tether Line -->
        <div id="leash-line" class="absolute origin-bottom w-[1px] bg-gradient-to-t from-blue-500/40 to-transparent bottom-1/2 left-1/2 -translate-x-1/2 h-0 transition-all duration-500"></div>
    </div>

    <!-- Navigation Data & Primary Controls -->
    <div class="w-full max-w-xs space-y-8 z-20">
        <div id="telemetry" class="text-center">
            <div id="dist-val" class="text-6xl font-extralight tracking-tighter leading-none">--</div>
            <div class="text-[10px] uppercase tracking-[0.2em] mt-2 opacity-30">Meters to Destination</div>
        </div>

        <div id="controls-panel" class="space-y-3">
            <button id="auth-btn" class="w-full py-5 bg-white text-black rounded-3xl font-bold text-sm tracking-widest uppercase transition-all active:scale-95 shadow-xl">
                Initialize System
            </button>
            <button id="start-btn" class="hidden w-full py-5 bg-blue-600 text-white rounded-3xl font-bold text-sm tracking-widest uppercase shadow-lg shadow-blue-900/40 active:scale-95 animate-pulse">
                Begin Walk
            </button>
        </div>

        <div class="text-[9px] text-center text-zinc-500 uppercase tracking-widest leading-relaxed opacity-60">
            Binaural Guidance Active<br>Center footsteps in your hearing
        </div>
    </div>

<script>
    /**
     * IIT BOMBAY PATH DATA: Hostel 15 to IDC Iconic Building
     * Calculated path nodes for real-world navigation.
     */
    const TARGET_GPS = { lat: 19.131550, lng: 72.915720 }; // IDC Building
    
    const STATE = {
        isLive: false,
        userLat: 0,
        userLng: 0,
        heading: 0,
        dogAlpha: 1.0,
        milestones: { p20: false, p50: false, p75: false, arrived: false }
    };

    let audioCtx, panner, footstepTimer;

    const statusDisplay = document.getElementById('gps-status');

    /**
     * SENSOR INITIALIZATION (Hardware Unlock)
     */
    document.getElementById('auth-btn').onclick = async () => {
        statusDisplay.innerText = "Requesting Hardware Access...";

        try {
            // 1. iOS Motion & Orientation Access
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                const permission = await DeviceOrientationEvent.requestPermission();
                if (permission !== 'granted') throw new Error("Compass access required.");
            }

            // 2. Browser Geolocation Access
            const pos = await new Promise((res, rej) => {
                navigator.geolocation.getCurrentPosition(res, rej, { enableHighAccuracy: true, timeout: 10000 });
            });

            STATE.userLat = pos.coords.latitude;
            STATE.userLng = pos.coords.longitude;

            // 3. Audio Engine Unlock
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            panner = audioCtx.createPanner();
            panner.panningModel = 'HRTF';
            panner.distanceModel = 'inverse';
            panner.connect(audioCtx.destination);

            // 4. Set Hardware Listeners
            window.addEventListener('deviceorientationabsolute', (e) => {
                STATE.heading = e.alpha || e.webkitCompassHeading || 0;
            }, true);

            navigator.geolocation.watchPosition(
                (p) => {
                    STATE.userLat = p.coords.latitude;
                    STATE.userLng = p.coords.longitude;
                    updateNavigationLogic();
                    statusDisplay.innerText = `GPS Active (Accuracy: ${p.coords.accuracy.toFixed(1)}m)`;
                    statusDisplay.className = "text-[10px] success font-mono mt-2 uppercase tracking-widest";
                },
                (e) => {
                    statusDisplay.innerText = `GPS Lost: ${e.message}`;
                    statusDisplay.className = "text-[10px] error font-mono mt-2 uppercase tracking-widest";
                },
                { enableHighAccuracy: true, maximumAge: 0 }
            );

            // Ready to start
            document.getElementById('auth-btn').classList.add('hidden');
            document.getElementById('start-btn').classList.remove('hidden');

        } catch (err) {
            statusDisplay.innerText = `System Error: ${err.message}`;
            statusDisplay.className = "text-[10px] error font-mono mt-2 uppercase tracking-widest";
        }
    };

    /**
     * PROCEDURAL AUDIO ENGINE (Dog Footsteps)
     */
    const triggerFootstep = () => {
        if (!STATE.isLive || !audioCtx) return;
        
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        
        // Padded footfall sound
        osc.type = 'triangle';
        osc.frequency.setValueAtTime(110, audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(30, audioCtx.currentTime + 0.1);
        
        gain.gain.setValueAtTime(0.15, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
        
        osc.connect(gain);
        gain.connect(panner);
        osc.start();
        osc.stop(audioCtx.currentTime + 0.1);
    };

    const playNodeChime = (freq, vol, duration, isDouble = false) => {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        gain.gain.setValueAtTime(0, audioCtx.currentTime);
        gain.gain.linearRampToValueAtTime(vol, audioCtx.currentTime + 0.05);
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + duration);
        if (isDouble) setTimeout(() => playNodeChime(freq, vol, duration, false), 350);
    };

    /**
     * GEOSPATIAL LOGIC
     */
    const calcDist = (lat1, lon1, lat2, lon2) => {
        const R = 6371000; // Meters
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLon / 2) * Math.sin(dLon / 2);
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    };

    const calcBearing = (lat1, lon1, lat2, lon2) => {
        const y = Math.sin((lon2 - lon1) * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180);
        const x = Math.cos(lat1 * Math.PI / 180) * Math.sin(lat2 * Math.PI / 180) -
                  Math.sin(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.cos((lon2 - lon1) * Math.PI / 180);
        return (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
    };

    function updateNavigationLogic() {
        if (STATE.userLat === 0) return;

        const distance = calcDist(STATE.userLat, STATE.userLng, TARGET_GPS.lat, TARGET_GPS.lng);
        document.getElementById('dist-val').innerText = Math.round(distance);

        // Calculate Relative Binaural Direction
        const absBearing = calcBearing(STATE.userLat, STATE.userLng, TARGET_GPS.lat, TARGET_GPS.lng);
        const relativeDir = (absBearing - STATE.heading + 360) % 360;
        
        // Update 3D Audio Source
        // Note: Panner coordinates (X: Left/Right, Y: Height, Z: Depth)
        const rad = (relativeDir - 90) * (Math.PI / 180);
        const panX = Math.cos(rad) * 6; // Dog positioned 6m away
        const panZ = Math.sin(rad) * 6;
        panner.setPosition(panX, 0, panZ);

        // Update Interface Visuals
        const avatar = document.getElementById('dog-avatar');
        const leash = document.getElementById('leash-line');
        avatar.style.transform = `rotate(${relativeDir}deg) translateY(-120px) rotate(-${relativeDir}deg)`;
        leash.style.transform = `translate(-50%, 0) rotate(${relativeDir}deg)`;
        leash.style.height = `120px`;

        // Progression Chimes
        const startDist = 550; // Total path approx 550m
        const prog = 1 - (distance / startDist);
        
        if (prog >= 0.2 && !STATE.milestones.p20) { playNodeChime(440, 0.2, 0.6); STATE.milestones.p20 = true; }
        if (prog >= 0.5 && !STATE.milestones.p50) { playNodeChime(554, 0.4, 0.6); STATE.milestones.p50 = true; }
        if (prog >= 0.75 && !STATE.milestones.p75) { playNodeChime(659, 0.3, 0.6, true); STATE.milestones.p75 = true; }
        
        if (distance < 12 && !STATE.milestones.arrived) {
            playNodeChime(880, 0.5, 2.0, true);
            STATE.milestones.arrived = true;
            document.getElementById('controls-panel').innerHTML = `<div class="text-green-400 font-bold text-center tracking-[0.4em] animate-pulse">ARRIVED AT IDC</div>`;
            if (window.navigator.vibrate) window.navigator.vibrate([300, 100, 300, 100, 500]);
        }
    }

    /**
     * INITIAL EXPERIENCE START
     */
    document.getElementById('start-btn').onclick = () => {
        STATE.isLive = true;
        document.getElementById('start-btn').style.display = 'none';
        document.getElementById('dog-avatar').style.opacity = '1';
        
        // Experience Transition: Dog visual fades out over 12 seconds
        let startTime = Date.now();
        const visualFader = setInterval(() => {
            const elapsed = Date.now() - startTime;
            STATE.dogAlpha = 1 - (elapsed / 12000);
            document.getElementById('dog-avatar').style.opacity = Math.max(0, STATE.dogAlpha);
            document.getElementById('leash-line').style.opacity = Math.max(0, STATE.dogAlpha * 0.4);
            if (STATE.dogAlpha <= 0) clearInterval(visualFader);
        }, 100);

        // Start High-Resolution Guidance Loops
        footstepTimer = setInterval(triggerFootstep, 650);
        setInterval(updateNavigationLogic, 100);
        
        // Add visual ambient pulses
        setInterval(() => {
            if (!STATE.isLive) return;
            const p = document.createElement('div');
            p.className = 'audio-pulse';
            document.getElementById('pulse-container').appendChild(p);
            setTimeout(() => p.remove(), 4000);
        }, 2000);
    };

</script>
</body>
</html>