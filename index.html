<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Acoustic Leash - Real World GPS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #050505;
            color: #f4f4f5;
            user-select: none;
            touch-action: none;
            overflow: hidden;
            font-family: 'Inter', system-ui, sans-serif;
        }
        .compass-ring {
            transition: transform 0.1s ease-out;
        }
        .status-pill {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body class="flex flex-col items-center justify-between h-screen p-6 py-12">

    <!-- Top Status Section -->
    <div class="w-full space-y-4 text-center">
        <h1 class="text-xl font-light tracking-[0.3em] uppercase opacity-60">Acoustic Leash</h1>
        <div id="route-indicator" class="status-pill rounded-full py-2 px-4 inline-block">
            <span class="text-blue-400 text-[10px] font-bold tracking-widest uppercase">H15 ‚Üí IDC School of Design</span>
        </div>
        <div id="gps-status" class="text-[10px] text-zinc-500 font-mono mt-2">Waiting for GPS signal...</div>
    </div>

    <!-- Center Compass/Visualizer -->
    <div class="relative w-64 h-64 flex items-center justify-center">
        <!-- Outer Compass Ring -->
        <div id="compass" class="absolute inset-0 border border-zinc-800 rounded-full opacity-20"></div>
        
        <!-- The User (Static Center) -->
        <div class="z-10 w-3 h-3 bg-white rounded-full shadow-[0_0_15px_rgba(255,255,255,0.5)]"></div>
        
        <!-- The Dog (Audio Source Representation) -->
        <div id="dog-visual" class="absolute w-6 h-6 flex items-center justify-center transition-all duration-300 opacity-0">
            <span class="text-xl">üêï</span>
        </div>

        <!-- Connection Line -->
        <div id="tether-line" class="absolute origin-bottom w-[1px] bg-blue-500/30 bottom-1/2 left-1/2 -translate-x-1/2 h-0"></div>
    </div>

    <!-- Bottom Controls & Navigation -->
    <div class="w-full max-w-xs space-y-6">
        <div id="distance-display" class="text-center">
            <div class="text-4xl font-light tracking-tighter" id="dist-val">--</div>
            <div class="text-[10px] uppercase tracking-widest opacity-40">meters to target</div>
        </div>

        <div id="action-area" class="flex flex-col gap-3">
            <button id="sensor-btn" class="w-full py-4 bg-zinc-900 border border-zinc-800 text-white rounded-2xl font-medium text-sm transition-all active:scale-95">
                CALIBRATE SENSORS
            </button>
            <button id="start-btn" class="hidden w-full py-4 bg-blue-600 text-white rounded-2xl font-bold text-sm shadow-lg shadow-blue-900/20 active:scale-95">
                START GUIDANCE
            </button>
        </div>

        <div class="text-[9px] text-center text-zinc-600 uppercase tracking-widest leading-loose">
            Binaural Audio System<br>Keep footsteps centered in your ears
        </div>
    </div>

    <!-- Hidden audio elements and overlays -->
    <div id="vibe-log" class="fixed bottom-4 left-4 text-[8px] opacity-20 font-mono"></div>

<script>
    /**
     * GPS PATH: Hostel 15 to IDC Iconic Building (Approximate Path Nodes)
     */
    const PATH = [
        { lat: 19.136200, lng: 72.915500 }, // Hostel 15 Entrance
        { lat: 19.135600, lng: 72.915600 }, // Turn onto main path
        { lat: 19.134000, lng: 72.915300 }, // Pass near Gymkhana
        { lat: 19.132500, lng: 72.915400 }, // Approaching IDC area
        { lat: 19.131550, lng: 72.915720 }  // IDC Iconic Building
    ];

    const STATE = {
        active: false,
        userLat: 0,
        userLng: 0,
        heading: 0,
        dogLat: 0,
        dogLng: 0,
        dogAlpha: 1.0,
        milestones: { p20: false, p50: false, p75: false, done: false },
        totalDistance: 0
    };

    let audioCtx, panner, footstepLoop;

    /**
     * SENSOR INITIALIZATION
     */
    document.getElementById('sensor-btn').onclick = async () => {
        // Request Orientation (iOS 13+)
        if (typeof DeviceOrientationEvent.requestPermission === 'function') {
            const permission = await DeviceOrientationEvent.requestPermission();
            if (permission !== 'granted') {
                alert("Orientation permission required for spatial audio.");
                return;
            }
        }

        // Initialize Audio
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        panner = audioCtx.createPanner();
        panner.panningModel = 'HRTF';
        panner.distanceModel = 'inverse';
        panner.connect(audioCtx.destination);

        // Start Compass Tracking
        window.addEventListener('deviceorientationabsolute', (e) => {
            // deviceorientationabsolute is more reliable for north-alignment
            STATE.heading = e.alpha || e.webkitCompassHeading || 0;
        }, true);

        // Start GPS Tracking
        navigator.geolocation.watchPosition(
            (pos) => {
                STATE.userLat = pos.coords.latitude;
                STATE.userLng = pos.coords.longitude;
                updateNavigation();
                document.getElementById('gps-status').innerText = `GPS Fixed: ${STATE.userLat.toFixed(5)}, ${STATE.userLng.toFixed(5)}`;
            },
            (err) => { document.getElementById('gps-status').innerText = "GPS Error: Please enable location."; },
            { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
        );

        document.getElementById('sensor-btn').classList.add('hidden');
        document.getElementById('start-btn').classList.remove('hidden');
    };

    /**
     * AUDIO ENGINE
     */
    const playFootstep = () => {
        if (!STATE.active) return;
        
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'triangle';
        osc.frequency.setValueAtTime(100, audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(30, audioCtx.currentTime + 0.1);
        
        gain.gain.setValueAtTime(0.12, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
        
        osc.connect(gain);
        gain.connect(panner);
        osc.start();
        osc.stop(audioCtx.currentTime + 0.1);
    };

    const playChime = (freq, vol, duration, double = false) => {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        gain.gain.setValueAtTime(0, audioCtx.currentTime);
        gain.gain.linearRampToValueAtTime(vol, audioCtx.currentTime + 0.05);
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + duration);
        if (double) setTimeout(() => playChime(freq, vol, duration, false), 250);
    };

    /**
     * GEOMETRY & MATH
     */
    const getDistance = (lat1, lon1, lat2, lon2) => {
        const R = 6371e3; // metres
        const œÜ1 = lat1 * Math.PI/180;
        const œÜ2 = lat2 * Math.PI/180;
        const ŒîœÜ = (lat2-lat1) * Math.PI/180;
        const ŒîŒª = (lon2-lon1) * Math.PI/180;
        const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                  Math.cos(œÜ1) * Math.cos(œÜ2) *
                  Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    };

    const getBearing = (lat1, lon1, lat2, lon2) => {
        const y = Math.sin((lon2-lon1) * Math.PI/180) * Math.cos(lat2 * Math.PI/180);
        const x = Math.cos(lat1 * Math.PI/180) * Math.sin(lat2 * Math.PI/180) -
                  Math.sin(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) * Math.cos((lon2-lon1) * Math.PI/180);
        const brng = Math.atan2(y, x);
        return (brng * 180 / Math.PI + 360) % 360;
    };

    /**
     * CORE NAVIGATION LOOP
     */
    function updateNavigation() {
        if (STATE.userLat === 0) return;

        // 1. Find the target: Hostel 15 to IDC is roughly 550m.
        const destination = PATH[PATH.length - 1];
        const distToFinal = getDistance(STATE.userLat, STATE.userLng, destination.lat, destination.lng);
        document.getElementById('dist-val').innerText = Math.round(distToFinal);

        // 2. Determine "Dog" Position (6 meters ahead on path)
        // For prototype, we point directly at destination or next waypoint
        const bearingToTarget = getBearing(STATE.userLat, STATE.userLng, destination.lat, destination.lng);
        
        // 3. Audio Spatialization
        // Relative bearing = Target Bearing - User Compass Heading
        // This is where the magic happens: the audio stays "fixed" in space
        const relativeBearing = (bearingToTarget - STATE.heading + 360) % 360;
        const rad = (relativeBearing - 90) * (Math.PI / 180); // Adjust for audio coord system
        
        // Panner position (X is Left/Right, Z is Front/Back)
        const pX = Math.cos(rad) * 5; 
        const pZ = Math.sin(rad) * 5;
        panner.setPosition(pX, 0, pZ);

        // 4. Update Visuals
        const dog = document.getElementById('dog-visual');
        const tether = document.getElementById('tether-line');
        const visualDist = 120; // Max pixels
        dog.style.transform = `rotate(${relativeBearing}deg) translateY(-${visualDist}px) rotate(-${relativeBearing}deg)`;
        tether.style.transform = `translate(-50%, 0) rotate(${relativeBearing}deg)`;
        tether.style.height = `${visualDist}px`;

        // 5. Milestones
        const totalExpected = 550; 
        const prog = 1 - (distToFinal / totalExpected);
        
        if (prog >= 0.2 && !STATE.milestones.p20) { playChime(440, 0.2, 0.5); STATE.milestones.p20 = true; }
        if (prog >= 0.5 && !STATE.milestones.p50) { playChime(554, 0.4, 0.5); STATE.milestones.p50 = true; }
        if (prog >= 0.75 && !STATE.milestones.p75) { playChime(659, 0.3, 0.5, true); STATE.milestones.p75 = true; }
        if (distToFinal < 5 && !STATE.milestones.done) {
            playChime(880, 0.5, 2.0, true);
            STATE.milestones.done = true;
            document.getElementById('action-area').innerHTML = `<div class="text-blue-500 font-bold text-center">ARRIVED AT IDC</div>`;
        }
    }

    document.getElementById('start-btn').onclick = () => {
        STATE.active = true;
        document.getElementById('start-btn').style.display = 'none';
        document.getElementById('dog-visual').style.opacity = '1';
        
        // Visual Handoff: Fade dog visual over 10 seconds
        let startTime = Date.now();
        const fade = setInterval(() => {
            const elapsed = Date.now() - startTime;
            STATE.dogAlpha = 1 - (elapsed / 10000);
            document.getElementById('dog-visual').style.opacity = Math.max(0, STATE.dogAlpha);
            document.getElementById('tether-line').style.opacity = Math.max(0, STATE.dogAlpha * 0.3);
            if (STATE.dogAlpha <= 0) clearInterval(fade);
        }, 100);

        // CONSTANT FOOTSTEP LOOP
        // Regardless of walking, footsteps guide the way
        footstepLoop = setInterval(playFootstep, 600);
        
        // Start Render/Update Loop
        setInterval(updateNavigation, 100);
    };

</script>
</body>
</html>